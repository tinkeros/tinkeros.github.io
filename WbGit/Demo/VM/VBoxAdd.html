<!DOCTYPE HTML>
<html style="background-color:#FFFFFF;">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=US-ASCII">
<title>The Temple Operating System</title>
<meta name="keywords" content="Operating System,64-Bit,64 Bit,Temple,OS,TempleOS,Free,Open Source,Public Domain,x86_64">
<meta name="generator" content="TinkerOS V5.20">
<style type="text/css">
.cB0{color:#000000;background-color:#55ffff;}
.cB1{color:#0000aa;background-color:#55ffff;}
.cB2{color:#00aa00;background-color:#55ffff;}
.cB3{color:#00aaaa;background-color:#55ffff;}
.cB5{color:#aa00aa;background-color:#55ffff;}
.cB6{color:#aa5500;background-color:#55ffff;}
.cB7{color:#aaaaaa;background-color:#55ffff;}
.cB9{color:#5555ff;background-color:#55ffff;}
.cF0{color:#000000;background-color:#ffffff;}
.cF1{color:#0000aa;background-color:#ffffff;}
.cF2{color:#00aa00;background-color:#ffffff;}
.cF3{color:#00aaaa;background-color:#ffffff;}
.cF4{color:#aa0000;background-color:#ffffff;}
.cF5{color:#aa00aa;background-color:#ffffff;}
.cF6{color:#aa5500;background-color:#ffffff;}
.cF7{color:#aaaaaa;background-color:#ffffff;}
.cF8{color:#555555;background-color:#ffffff;}
.cF9{color:#5555ff;background-color:#ffffff;}
.cFA{color:#55ff55;background-color:#ffffff;}
.cFB{color:#55ffff;background-color:#ffffff;}
.cFC{color:#ff5555;background-color:#ffffff;}
.cFD{color:#ff55ff;background-color:#ffffff;}
.cFE{color:#ffff55;background-color:#ffffff;}
.cFF{color:#ffffff;background-color:#ffffff;}
</style>
</head>
<body style="background-color:#55FFFF; border-style:solid;
	  border-width:8px; border-color:#0000AA;
	  margin-left:auto; margin-right:auto; width:800px; ">
<pre style="font-family:courier;font-size:10pt;font-variant-ligatures: none;">
<div style="margin-left:auto; margin-right:auto; width: 640px;">
<a name="l1"></a><span class=cB0>#</span><span class=cB1>define</span><span class=cB0> VBOX_VMMDEV_VERSION 0x00010003
<a name="l2"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_REQUEST_HEADER_VERSION 0x10001
<a name="l3"></a>
<a name="l4"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_REQUEST_GUEST_INFO 50
<a name="l5"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_REQUEST_SET_GUEST_CAPS 55
<a name="l6"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_REQUEST_HGCM_CONNECT 60
<a name="l7"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_REQUEST_HGCM_DISCONNECT 61
<a name="l8"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_REQUEST_HGCM_CALL 62
<a name="l9"></a>
<a name="l10"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_REQUEST_GET_MOUSE 1
<a name="l11"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_REQUEST_SET_MOUSE 2
<a name="l12"></a>
<a name="l13"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_SHARED_CLIPBOARD_FMT_UNICODETEXT 1
<a name="l14"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_SHARED_CLIPBOARD_FMT_BITMAP 2
<a name="l15"></a>
<a name="l16"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_SHARED_CLIPBOARD_FN_GET_HOST_MSG 1
<a name="l17"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_SHARED_CLIPBOARD_FN_FMTS 2
<a name="l18"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_SHARED_CLIPBOARD_FN_READ_DATA 3
<a name="l19"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_SHARED_CLIPBOARD_FN_WRITE_DATA 4
<a name="l20"></a>
<a name="l21"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_SHARED_CLIPBOARD_HOST_MSG_READ_DATA 2
<a name="l22"></a>#</span><span class=cB1>define</span><span class=cB0> VBOX_SHARED_CLIPBOARD_HOST_MSG_FMTS 3
<a name="l23"></a>
<a name="l24"></a>#</span><span class=cB1>define</span><span class=cB0> HOST_CLIP_READ_MAX 32768
<a name="l25"></a>#</span><span class=cB1>define</span><span class=cB0> HOST_CLIP_WRITE_MAX 32768
<a name="l26"></a>
<a name="l27"></a>#</span><span class=cB1>define</span><span class=cB0> MS_MSG_MS 12
<a name="l28"></a>#</span><span class=cB1>define</span><span class=cB0> CLIP_MSG_MS 10
<a name="l29"></a>#</span><span class=cB1>define</span><span class=cB0> MSG_REQ_MS 20
<a name="l30"></a>
<a name="l31"></a></span><span class=cB1>class</span><span class=cB0> VBGuestHdr
<a name="l32"></a>{
<a name="l33"></a>  </span><span class=cB9>U32</span><span class=cB0> size;
<a name="l34"></a>  </span><span class=cB9>U32</span><span class=cB0> ver;
<a name="l35"></a>  </span><span class=cB9>U32</span><span class=cB0> req_type;
<a name="l36"></a>  </span><span class=cB9>I32</span><span class=cB0> rc;
<a name="l37"></a>  </span><span class=cB9>U32</span><span class=cB0> reserved1;
<a name="l38"></a>  </span><span class=cB9>U32</span><span class=cB0> reserved2;
<a name="l39"></a>};
<a name="l40"></a>
<a name="l41"></a></span><span class=cB1>class</span><span class=cB0> VBGuestInfo
<a name="l42"></a>{
<a name="l43"></a>  VBGuestHdr hdr;
<a name="l44"></a>  </span><span class=cB9>U32</span><span class=cB0> ver;
<a name="l45"></a>  </span><span class=cB9>U32</span><span class=cB0> ostype;
<a name="l46"></a>};
<a name="l47"></a>
<a name="l48"></a></span><span class=cB1>class</span><span class=cB0> VBGuestMsAbs
<a name="l49"></a>{
<a name="l50"></a>  VBGuestHdr hdr;
<a name="l51"></a>  </span><span class=cB9>U32</span><span class=cB0> features;
<a name="l52"></a>  </span><span class=cB9>I32</span><span class=cB0> x;
<a name="l53"></a>  </span><span class=cB9>I32</span><span class=cB0> y;
<a name="l54"></a>};
<a name="l55"></a>
<a name="l56"></a></span><span class=cB1>class</span><span class=cB0> VBGuest
<a name="l57"></a>{
<a name="l58"></a>  </span><span class=cB9>U32</span><span class=cB0> port;
<a name="l59"></a>  </span><span class=cB9>U32</span><span class=cB0> vmmdev;
<a name="l60"></a>  </span><span class=cB9>U32</span><span class=cB0> irq;
<a name="l61"></a>};
<a name="l62"></a>
<a name="l63"></a></span><span class=cB1>class</span><span class=cB0> VBoxHGCMHdr
<a name="l64"></a>{
<a name="l65"></a>  </span><span class=cB9>U32</span><span class=cB0> size;
<a name="l66"></a>  </span><span class=cB9>U32</span><span class=cB0> ver;
<a name="l67"></a>  </span><span class=cB9>U32</span><span class=cB0> req_type;
<a name="l68"></a>  </span><span class=cB9>I32</span><span class=cB0> rc;
<a name="l69"></a>  </span><span class=cB9>U32</span><span class=cB0> reserved1;
<a name="l70"></a>  </span><span class=cB9>U32</span><span class=cB0> reserved2;
<a name="l71"></a>  </span><span class=cB9>U32</span><span class=cB0> flags;
<a name="l72"></a>  </span><span class=cB9>I32</span><span class=cB0> result;
<a name="l73"></a>};
<a name="l74"></a>
<a name="l75"></a></span><span class=cB1>class</span><span class=cB0> VBoxClipConnect
<a name="l76"></a>{
<a name="l77"></a>  VBoxHGCMHdr hdr;
<a name="l78"></a>  </span><span class=cB9>U32</span><span class=cB0> loc_type;
<a name="l79"></a>  </span><span class=cB1>U8</span><span class=cB0> loc[128];
<a name="l80"></a>  </span><span class=cB9>U32</span><span class=cB0> client_id;
<a name="l81"></a>  </span><span class=cB9>U32</span><span class=cB0> msg;
<a name="l82"></a>  </span><span class=cB9>U32</span><span class=cB0> fmts;
<a name="l83"></a>};
<a name="l84"></a>
<a name="l85"></a></span><span class=cB1>class</span><span class=cB0> VBoxHGCParam
<a name="l86"></a>{
<a name="l87"></a>  </span><span class=cB9>U32</span><span class=cB0> type;
<a name="l88"></a>  </span><span class=cB9>U64</span><span class=cB0> value;
<a name="l89"></a>};
<a name="l90"></a>
<a name="l91"></a></span><span class=cB1>class</span><span class=cB0> VBoxHGCPtr
<a name="l92"></a>{
<a name="l93"></a>  </span><span class=cB9>U32</span><span class=cB0> type;
<a name="l94"></a>  </span><span class=cB9>U32</span><span class=cB0> size;
<a name="l95"></a>  </span><span class=cB9>U32</span><span class=cB0> ptr;
<a name="l96"></a>};
<a name="l97"></a>
<a name="l98"></a></span><span class=cB1>class</span><span class=cB0> VBoxClipFmts
<a name="l99"></a>{
<a name="l100"></a>  VBoxHGCMHdr hdr;
<a name="l101"></a>  </span><span class=cB9>U32</span><span class=cB0> client_id;
<a name="l102"></a>  </span><span class=cB9>U32</span><span class=cB0> func_code;
<a name="l103"></a>  </span><span class=cB9>U32</span><span class=cB0> param_cnt;
<a name="l104"></a>  VBoxHGCParam fmts;
<a name="l105"></a>};
<a name="l106"></a>
<a name="l107"></a></span><span class=cB1>class</span><span class=cB0> VBoxClipMsg
<a name="l108"></a>{
<a name="l109"></a>  VBoxHGCMHdr hdr;
<a name="l110"></a>  </span><span class=cB9>U32</span><span class=cB0> client_id;
<a name="l111"></a>  </span><span class=cB9>U32</span><span class=cB0> func_code;
<a name="l112"></a>  </span><span class=cB9>U32</span><span class=cB0> param_cnt;
<a name="l113"></a>  VBoxHGCParam msg;
<a name="l114"></a>  VBoxHGCParam fmts;
<a name="l115"></a>};
<a name="l116"></a>
<a name="l117"></a></span><span class=cB1>class</span><span class=cB0> VBoxClipRead
<a name="l118"></a>{
<a name="l119"></a>  VBoxHGCMHdr hdr;
<a name="l120"></a>  </span><span class=cB9>U32</span><span class=cB0> client_id;
<a name="l121"></a>  </span><span class=cB9>U32</span><span class=cB0> func_code;
<a name="l122"></a>  </span><span class=cB9>U32</span><span class=cB0> param_cnt;
<a name="l123"></a>  VBoxHGCParam fmt;
<a name="l124"></a>  VBoxHGCPtr ptr;
<a name="l125"></a>  VBoxHGCParam size;
<a name="l126"></a>};
<a name="l127"></a>
<a name="l128"></a></span><span class=cB1>class</span><span class=cB0> VBoxClipWrite
<a name="l129"></a>{
<a name="l130"></a>  VBoxHGCMHdr hdr;
<a name="l131"></a>  </span><span class=cB9>U32</span><span class=cB0> client_id;
<a name="l132"></a>  </span><span class=cB9>U32</span><span class=cB0> func_code;
<a name="l133"></a>  </span><span class=cB9>U32</span><span class=cB0> param_cnt;
<a name="l134"></a>  VBoxHGCParam fmt;
<a name="l135"></a>  VBoxHGCPtr ptr;
<a name="l136"></a>};
<a name="l137"></a>
<a name="l138"></a></span><span class=cB1>class</span><span class=cB0> VBoxCaps
<a name="l139"></a>{
<a name="l140"></a>  VBGuestHdr hdr;
<a name="l141"></a>  </span><span class=cB9>U32</span><span class=cB0> caps;
<a name="l142"></a>};
<a name="l143"></a>
<a name="l144"></a></span><span class=cB1>static</span><span class=cB0> </span><span class=cB9>I16</span><span class=cB0> *utf16_host_write_clipboard=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l145"></a></span><span class=cB1>static</span><span class=cB0> </span><span class=cB1>U8</span><span class=cB0> *utf8_host_read_clipboard=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l146"></a></span><span class=cB1>static</span><span class=cB0> </span><span class=cB9>I16</span><span class=cB0> *utf16_host_read_clipboard=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l147"></a></span><span class=cB1>static</span><span class=cB0> <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l3795"></span><span class=cB9>CTask</a></span><span class=cB0> *vb_ms_task=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l148"></a></span><span class=cB1>static</span><span class=cB0> VBoxClipConnect *vbox_clip=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l149"></a></span><span class=cB1>static</span><span class=cB0> VBoxClipMsg *vbox_clip_msg=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l150"></a></span><span class=cB1>static</span><span class=cB0> VBoxClipRead *vbox_clip_read=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l151"></a></span><span class=cB1>static</span><span class=cB0> VBoxClipFmts *vbox_clip_fmts=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l152"></a></span><span class=cB1>static</span><span class=cB0> VBoxClipWrite *vbox_clip_write=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l153"></a></span><span class=cB1>static</span><span class=cB0> VBGuest vb_guest;
<a name="l154"></a></span><span class=cB1>static</span><span class=cB0> VBGuestMsAbs *mouse=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l155"></a></span><span class=cB1>static</span><span class=cB0> </span><span class=cB9>I64</span><span class=cB0> vb_msg_lock=0;
<a name="l156"></a>
<a name="l157"></a></span><span class=cB1>U0</span><span class=cB0> ToUTF16(</span><span class=cB1>U8</span><span class=cB0> *input)
<a name="l158"></a>{
<a name="l159"></a>  </span><span class=cB9>I64</span><span class=cB0> i, size;
<a name="l160"></a>  size=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l61"></span><span class=cB5>StrLen</a></span><span class=cB0>(input);
<a name="l161"></a>  </span><span class=cB1>if</span><span class=cB0> (size &gt; HOST_CLIP_WRITE_MAX)
<a name="l162"></a>    size = HOST_CLIP_WRITE_MAX;
<a name="l163"></a>  </span><span class=cB1>for</span><span class=cB0> (i = 0; i &lt; size; i++)
<a name="l164"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l165"></a>    utf16_host_write_clipboard[i]=input[i];
<a name="l166"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l167"></a>  utf16_host_write_clipboard[size]=0;
<a name="l168"></a>}
<a name="l169"></a>
<a name="l170"></a></span><span class=cB1>U0</span><span class=cB0> ToUTF8(</span><span class=cB9>I16</span><span class=cB0> *input, </span><span class=cB9>I64</span><span class=cB0> size)
<a name="l171"></a>{
<a name="l172"></a>  </span><span class=cB9>I64</span><span class=cB0> i;
<a name="l173"></a>  size = size/2;
<a name="l174"></a>  </span><span class=cB1>if</span><span class=cB0> (size&gt;HOST_CLIP_READ_MAX)
<a name="l175"></a>    size=HOST_CLIP_READ_MAX-1;
<a name="l176"></a>  </span><span class=cB1>for</span><span class=cB0> (i = 0; i &lt; size; i++)
<a name="l177"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l178"></a>    utf8_host_read_clipboard[i] = input[i];
<a name="l179"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l180"></a>  utf8_host_read_clipboard[size]=0;
<a name="l181"></a>}
<a name="l182"></a>
<a name="l183"></a></span><span class=cB1>U0</span><span class=cB0> VBSendMsg(</span><span class=cB1>U8</span><span class=cB0> *msg, </span><span class=cB9>I64</span><span class=cB0> sleep=CLIP_MSG_MS)
<a name="l184"></a>{
<a name="l185"></a>  </span><span class=cB1>while</span><span class=cB0> (<a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l14"></span><span class=cB5>Bt</a></span><span class=cB7>(</span><span class=cB0>&amp;vb_msg_lock,0</span><span class=cB7>)</span><span class=cB0>)
<a name="l186"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l187"></a>    <a href="http://tinkeros.github.io/WbGit/Kernel/Sched.html#l288"></span><span class=cB5>Yield</a></span><span class=cB0>;
<a name="l188"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l189"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l26"></span><span class=cB5>LBts</a></span><span class=cB0>(&amp;vb_msg_lock, 0);
<a name="l190"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l79"></span><span class=cB5>OutU32</a></span><span class=cB0>(vb_guest.port, msg);
<a name="l191"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KMisc.html#l137"></span><span class=cB5>Sleep</a></span><span class=cB0>(sleep);
<a name="l192"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l24"></span><span class=cB5>LBtr</a></span><span class=cB0>(&amp;vb_msg_lock, 0);
<a name="l193"></a>}
<a name="l194"></a>
<a name="l195"></a></span><span class=cB1>U0</span><span class=cB0> VBGuestMsUpdate()
<a name="l196"></a>{
<a name="l197"></a>  </span><span class=cB9>I64</span><span class=cB0> dx,dy,x,y,slop=1;
<a name="l198"></a>  </span><span class=cB1>U8</span><span class=cB0> ms_buf[4];
<a name="l199"></a>
<a name="l200"></a>  VBSendMsg(mouse, MS_MSG_MS);
<a name="l201"></a>
<a name="l202"></a>  x = <a href="http://tinkeros.github.io/WbGit/Kernel/KCfg.html#l4"></span><span class=cB3>GR_WIDTH</a></span><span class=cB0> * (mouse-&gt;x) / 0xFFFF;
<a name="l203"></a>  y = <a href="http://tinkeros.github.io/WbGit/Kernel/KCfg.html#l5"></span><span class=cB3>GR_HEIGHT</a></span><span class=cB0> * (mouse-&gt;y) / 0xFFFF;
<a name="l204"></a>
<a name="l205"></a>  ms_buf[0]=0;
<a name="l206"></a>  ms_buf[3]=0;
<a name="l207"></a>
<a name="l208"></a>  dx=x-<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l34"></span><span class=cB6>ms</a></span><span class=cB0>.pos.x;
<a name="l209"></a>  dy=y-<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l34"></span><span class=cB6>ms</a></span><span class=cB0>.pos.y;
<a name="l210"></a>
<a name="l211"></a>
<a name="l212"></a>  </span><span class=cB1>if</span><span class=cB0> (<a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l97"></span><span class=cB5>AbsI64</a></span><span class=cB7>(</span><span class=cB0>dx</span><span class=cB7>)</span><span class=cB0>&lt;slop) dx=0;
<a name="l213"></a>  </span><span class=cB1>if</span><span class=cB0> (<a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l97"></span><span class=cB5>AbsI64</a></span><span class=cB7>(</span><span class=cB0>dy</span><span class=cB7>)</span><span class=cB0>&lt;slop) dy=0;
<a name="l214"></a>  </span><span class=cB1>if</span><span class=cB0> (!dx&amp;&amp;!dy) </span><span class=cB1>return</span><span class=cB0>;
<a name="l215"></a>
<a name="l216"></a>  dx=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l125"></span><span class=cB5>ClampI64</a></span><span class=cB0>(x-<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l34"></span><span class=cB6>ms</a></span><span class=cB0>.pos.x,-255,255);
<a name="l217"></a>  dy=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l125"></span><span class=cB5>ClampI64</a></span><span class=cB0>(y-<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l34"></span><span class=cB6>ms</a></span><span class=cB0>.pos.y,-255,255);
<a name="l218"></a>
<a name="l219"></a>  </span><span class=cB1>if</span><span class=cB0> (<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l37"></span><span class=cB6>ms_hard</a></span><span class=cB0>.bttns[0])
<a name="l220"></a>    ms_buf[0]|=1;
<a name="l221"></a>  </span><span class=cB1>if</span><span class=cB0> (<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l37"></span><span class=cB6>ms_hard</a></span><span class=cB0>.bttns[1])
<a name="l222"></a>    ms_buf[0]|=2;
<a name="l223"></a>  </span><span class=cB1>if</span><span class=cB0> (<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l37"></span><span class=cB6>ms_hard</a></span><span class=cB0>.bttns[2])
<a name="l224"></a>    ms_buf[0]|=4;
<a name="l225"></a>  </span><span class=cB1>if</span><span class=cB0> (<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l37"></span><span class=cB6>ms_hard</a></span><span class=cB0>.bttns[3])
<a name="l226"></a>    ms_buf[3]|=16;
<a name="l227"></a>  </span><span class=cB1>if</span><span class=cB0> (<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l37"></span><span class=cB6>ms_hard</a></span><span class=cB0>.bttns[4])
<a name="l228"></a>    ms_buf[3]|=32;
<a name="l229"></a>
<a name="l230"></a>  </span><span class=cB1>if</span><span class=cB0> (dx&lt;0)
<a name="l231"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l232"></a>    ms_buf[0]|=0x10;
<a name="l233"></a>    dx=-dx;
<a name="l234"></a>    dx=256-dx;
<a name="l235"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l236"></a>  </span><span class=cB1>if</span><span class=cB0> (dy&lt;=0)
<a name="l237"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l238"></a>    dy=-dy;
<a name="l239"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l240"></a>  </span><span class=cB1>else</span><span class=cB0>
<a name="l241"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l242"></a>    ms_buf[0]|=0x20;
<a name="l243"></a>    dy=256-dy;
<a name="l244"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l245"></a>
<a name="l246"></a>  ms_buf[1]=dx;
<a name="l247"></a>  ms_buf[2]=dy;
<a name="l248"></a>
<a name="l249"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/SerialDev/Mouse.html#l471"></span><span class=cB5>MsPktInject</a></span><span class=cB0>(ms_buf);
<a name="l250"></a>}
<a name="l251"></a>
<a name="l252"></a></span><span class=cB1>U0</span><span class=cB0> VBMsPollTask()
<a name="l253"></a>{
<a name="l254"></a>  </span><span class=cB1>while</span><span class=cB0> (1)
<a name="l255"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l256"></a>    </span><span class=cB1>if</span><span class=cB0> (vb_msg_lock)
<a name="l257"></a>      <a href="http://tinkeros.github.io/WbGit/Kernel/Sched.html#l288"></span><span class=cB5>Yield</a></span><span class=cB0>;
<a name="l258"></a>    </span><span class=cB1>else</span><span class=cB0>
<a name="l259"></a>      VBGuestMsUpdate;
<a name="l260"></a>    <a href="http://tinkeros.github.io/WbGit/Kernel/Sched.html#l288"></span><span class=cB5>Yield</a></span><span class=cB0>;
<a name="l261"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l262"></a>}
<a name="l263"></a>
<a name="l264"></a></span><span class=cB1>U0</span><span class=cB0> VBHostClipMsgReq()
<a name="l265"></a>{
<a name="l266"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l173"></span><span class=cB5>MemSet</a></span><span class=cB0>(vbox_clip_msg+</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxHGCMHdr</span><span class=cB7>)</span><span class=cB0>,0,</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipMsg</span><span class=cB7>)</span><span class=cB0>-</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxHGCMHdr</span><span class=cB7>)</span><span class=cB0>);
<a name="l267"></a>  vbox_clip_msg-&gt;client_id = vbox_clip-&gt;client_id;
<a name="l268"></a>  vbox_clip_msg-&gt;func_code = VBOX_SHARED_CLIPBOARD_FN_GET_HOST_MSG;
<a name="l269"></a>  vbox_clip_msg-&gt;param_cnt = 2;
<a name="l270"></a>  vbox_clip_msg-&gt;msg.type = 1;
<a name="l271"></a>  vbox_clip_msg-&gt;fmts.type = 1;
<a name="l272"></a>  VBSendMsg(vbox_clip_msg,MSG_REQ_MS);
<a name="l273"></a>}
<a name="l274"></a>
<a name="l275"></a></span><span class=cB1>U0</span><span class=cB0> VBHostClipRead()
<a name="l276"></a>{
<a name="l277"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l173"></span><span class=cB5>MemSet</a></span><span class=cB0>(vbox_clip_read+</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxHGCMHdr</span><span class=cB7>)</span><span class=cB0>,0,</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipRead</span><span class=cB7>)</span><span class=cB0>-</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxHGCMHdr</span><span class=cB7>)</span><span class=cB0>);
<a name="l278"></a>  vbox_clip_read-&gt;client_id = vbox_clip-&gt;client_id;
<a name="l279"></a>  vbox_clip_read-&gt;func_code = VBOX_SHARED_CLIPBOARD_FN_READ_DATA;
<a name="l280"></a>  vbox_clip_read-&gt;param_cnt = 3;
<a name="l281"></a>  vbox_clip_read-&gt;fmt.type = 1;
<a name="l282"></a>  vbox_clip_read-&gt;fmt.value = VBOX_SHARED_CLIPBOARD_FMT_UNICODETEXT;
<a name="l283"></a>  vbox_clip_read-&gt;ptr.type = 4;
<a name="l284"></a>  vbox_clip_read-&gt;ptr.size = HOST_CLIP_READ_MAX;
<a name="l285"></a>  vbox_clip_read-&gt;ptr.ptr = utf16_host_read_clipboard;
<a name="l286"></a>  vbox_clip_read-&gt;size.type = 1;
<a name="l287"></a>  VBSendMsg(vbox_clip_read);
<a name="l288"></a>}
<a name="l289"></a>
<a name="l290"></a></span><span class=cB1>U0</span><span class=cB0> VBHostClipFmts()
<a name="l291"></a>{
<a name="l292"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l173"></span><span class=cB5>MemSet</a></span><span class=cB0>(vbox_clip_fmts+</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxHGCMHdr</span><span class=cB7>)</span><span class=cB0>,0,</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipFmts</span><span class=cB7>)</span><span class=cB0>-</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxHGCMHdr</span><span class=cB7>)</span><span class=cB0>);
<a name="l293"></a>  vbox_clip_fmts-&gt;client_id = vbox_clip-&gt;client_id;
<a name="l294"></a>  vbox_clip_fmts-&gt;func_code = VBOX_SHARED_CLIPBOARD_FN_FMTS;
<a name="l295"></a>  vbox_clip_fmts-&gt;param_cnt = 1;
<a name="l296"></a>  vbox_clip_fmts-&gt;fmts.type = 1;
<a name="l297"></a>  vbox_clip_fmts-&gt;fmts.value = VBOX_SHARED_CLIPBOARD_FMT_UNICODETEXT;
<a name="l298"></a>  VBSendMsg(vbox_clip_fmts);
<a name="l299"></a>}
<a name="l300"></a>
<a name="l301"></a></span><span class=cB1>U0</span><span class=cB0> VBHostClipWrite(</span><span class=cB1>U8</span><span class=cB0> *str)
<a name="l302"></a>{
<a name="l303"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l173"></span><span class=cB5>MemSet</a></span><span class=cB0>(vbox_clip_write+</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxHGCMHdr</span><span class=cB7>)</span><span class=cB0>,0,</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipWrite</span><span class=cB7>)</span><span class=cB0>-</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxHGCMHdr</span><span class=cB7>)</span><span class=cB0>);
<a name="l304"></a>  ToUTF16(str);
<a name="l305"></a>  vbox_clip_write-&gt;client_id = vbox_clip-&gt;client_id;
<a name="l306"></a>  vbox_clip_write-&gt;func_code = VBOX_SHARED_CLIPBOARD_FN_WRITE_DATA;
<a name="l307"></a>  vbox_clip_write-&gt;param_cnt = 2;
<a name="l308"></a>  vbox_clip_write-&gt;fmt.type = 1;
<a name="l309"></a>  vbox_clip_write-&gt;fmt.value = VBOX_SHARED_CLIPBOARD_FMT_UNICODETEXT;
<a name="l310"></a>  vbox_clip_write-&gt;ptr.type = 4;
<a name="l311"></a>  vbox_clip_write-&gt;ptr.size = HOST_CLIP_WRITE_MAX;
<a name="l312"></a>  vbox_clip_write-&gt;ptr.ptr = utf16_host_write_clipboard;
<a name="l313"></a>  VBSendMsg(vbox_clip_write);
<a name="l314"></a>}
<a name="l315"></a>
<a name="l316"></a></span><span class=cB1>Bool</span><span class=cB0> VBGuestInit()
<a name="l317"></a>{
<a name="l318"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l2379"></span><span class=cB9>CPCIDev</a></span><span class=cB0> *vb_dev;
<a name="l319"></a>
<a name="l320"></a>  </span><span class=cB1>if</span><span class=cB0> (!<a href="http://tinkeros.github.io/WbGit/Kernel/KMisc.html#l435"></span><span class=cB5>IsHypervisorPresent</a></span><span class=cB0>)
<a name="l321"></a>    </span><span class=cB1>return</span><span class=cB0> <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l23"></span><span class=cB3>FALSE</a></span><span class=cB0>;
<a name="l322"></a>
<a name="l323"></a>  vb_dev = <a href="http://tinkeros.github.io/WbGit/Adam/Device/DevInfo.html#l370"></span><span class=cB5>PCIDevFind</a></span><span class=cB0>(,,0x80ee,0xcafe);
<a name="l324"></a>  </span><span class=cB1>if</span><span class=cB0> (vb_dev-&gt;base_code != 8 || vb_dev-&gt;sub_code != 128)
<a name="l325"></a>    </span><span class=cB1>return</span><span class=cB0> <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l23"></span><span class=cB3>FALSE</a></span><span class=cB0>;
<a name="l326"></a>
<a name="l327"></a>  vb_guest.port = <a href="http://tinkeros.github.io/WbGit/Kernel/PCI.html#l2"></span><span class=cB5>PCIReadU32</a></span><span class=cB0>(vb_dev-&gt;bus,vb_dev-&gt;<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l32"></span><span class=cB6>dev</a></span><span class=cB0>,vb_dev-&gt;fun, 0x10) &amp; 0xFFFFFFFC;
<a name="l328"></a>  vb_guest.vmmdev = <a href="http://tinkeros.github.io/WbGit/Kernel/PCI.html#l2"></span><span class=cB5>PCIReadU32</a></span><span class=cB0>(vb_dev-&gt;bus,vb_dev-&gt;<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l32"></span><span class=cB6>dev</a></span><span class=cB0>,vb_dev-&gt;fun, 0x14) &amp; 0xFFFFFFF0;
<a name="l329"></a>  vb_guest.irq = <a href="http://tinkeros.github.io/WbGit/Kernel/PCI.html#l21"></span><span class=cB5>PCIReadU8</a></span><span class=cB0>(vb_dev-&gt;bus,vb_dev-&gt;<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l32"></span><span class=cB6>dev</a></span><span class=cB0>,vb_dev-&gt;fun, 0x3C);
<a name="l330"></a>
<a name="l331"></a>  VBGuestInfo *guest_info =
<a name="l332"></a>      <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBGuestInfo</span><span class=cB7>)</span><span class=cB0>, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l333"></a>  guest_info-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBGuestInfo);
<a name="l334"></a>  guest_info-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l335"></a>  guest_info-&gt;hdr.req_type = VBOX_REQUEST_GUEST_INFO;
<a name="l336"></a>  guest_info-&gt;ver = VBOX_VMMDEV_VERSION;
<a name="l337"></a>  guest_info-&gt;ostype=0x00100;
<a name="l338"></a>
<a name="l339"></a>  vb_msg_lock=<a href="http://tinkeros.github.io/WbGit/Kernel/Mem/PageTables.html#l207"></span><span class=cB5>MemPageTable</a></span><span class=cB0>(&amp;vb_msg_lock);
<a name="l340"></a>  *(vb_msg_lock</span><span class=cB7>(</span><span class=cB9>I64</span><span class=cB0>*</span><span class=cB7>)</span><span class=cB0>)|=0x11;
<a name="l341"></a>  vb_msg_lock=0;
<a name="l342"></a>
<a name="l343"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l79"></span><span class=cB5>OutU32</a></span><span class=cB0>(vb_guest.port, guest_info);
<a name="l344"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KMisc.html#l137"></span><span class=cB5>Sleep</a></span><span class=cB0>(20);
<a name="l345"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l415"></span><span class=cB5>Free</a></span><span class=cB0>(guest_info);
<a name="l346"></a>  </span><span class=cB1>return</span><span class=cB0> <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l22"></span><span class=cB3>TRUE</a></span><span class=cB0>;
<a name="l347"></a>}
<a name="l348"></a>
<a name="l349"></a></span><span class=cB1>U0</span><span class=cB0> VBMouseInit()
<a name="l350"></a>{
<a name="l351"></a>  mouse =
<a name="l352"></a>      <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBGuestMsAbs</span><span class=cB7>)</span><span class=cB0>, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l353"></a>  mouse-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBGuestMsAbs);
<a name="l354"></a>  mouse-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l355"></a>  mouse-&gt;hdr.req_type = VBOX_REQUEST_SET_MOUSE;
<a name="l356"></a>  mouse-&gt;features = (1 &lt;&lt; 0) | (1 &lt;&lt; 4);
<a name="l357"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l79"></span><span class=cB5>OutU32</a></span><span class=cB0>(vb_guest.port, mouse);
<a name="l358"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KMisc.html#l137"></span><span class=cB5>Sleep</a></span><span class=cB0>(20);
<a name="l359"></a>  mouse-&gt;hdr.req_type = VBOX_REQUEST_GET_MOUSE;
<a name="l360"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/Job.html#l462"></span><span class=cB5>AdamLog</a></span><span class=cB0>(</span><span class=cB6>&quot;Enabling VirtualBox mouse integration!\n&quot;</span><span class=cB0>);
<a name="l361"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l37"></span><span class=cB6>ms_hard</a></span><span class=cB0>.scale.x=0.25;
<a name="l362"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l37"></span><span class=cB6>ms_hard</a></span><span class=cB0>.scale.y=0.25;
<a name="l363"></a>  vb_ms_task=<a href="http://tinkeros.github.io/WbGit/Kernel/KTask.html#l247"></span><span class=cB5>Spawn</a></span><span class=cB0>(&amp;VBMsPollTask,,</span><span class=cB6>&quot;VBMsTask&quot;</span><span class=cB0>,-1);
<a name="l364"></a>}
<a name="l365"></a>
<a name="l366"></a></span><span class=cB1>Bool</span><span class=cB0> VBClipInit()
<a name="l367"></a>{
<a name="l368"></a>  utf8_host_read_clipboard = <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l427"></span><span class=cB5>CAlloc</a></span><span class=cB0>(HOST_CLIP_READ_MAX);
<a name="l369"></a>  utf16_host_read_clipboard = <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(HOST_CLIP_READ_MAX*2, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l370"></a>  utf16_host_write_clipboard = <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(HOST_CLIP_WRITE_MAX*2, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l371"></a>
<a name="l372"></a>  vbox_clip = <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipConnect</span><span class=cB7>)</span><span class=cB0>, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l373"></a>  vbox_clip_msg = <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipMsg</span><span class=cB7>)</span><span class=cB0>, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l374"></a>  vbox_clip_read = <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipRead</span><span class=cB7>)</span><span class=cB0>, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l375"></a>  vbox_clip_fmts = <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipFmts</span><span class=cB7>)</span><span class=cB0>, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l376"></a>  vbox_clip_write = <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipWrite</span><span class=cB7>)</span><span class=cB0>, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l377"></a>
<a name="l378"></a>  vbox_clip_write-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBoxClipWrite);
<a name="l379"></a>  vbox_clip_write-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l380"></a>  vbox_clip_write-&gt;hdr.req_type = VBOX_REQUEST_HGCM_CALL;
<a name="l381"></a>  vbox_clip_fmts-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBoxClipFmts);
<a name="l382"></a>  vbox_clip_fmts-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l383"></a>  vbox_clip_fmts-&gt;hdr.req_type = VBOX_REQUEST_HGCM_CALL;
<a name="l384"></a>  vbox_clip_read-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBoxClipRead);
<a name="l385"></a>  vbox_clip_read-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l386"></a>  vbox_clip_read-&gt;hdr.req_type = VBOX_REQUEST_HGCM_CALL;
<a name="l387"></a>  vbox_clip_msg-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBoxClipMsg);
<a name="l388"></a>  vbox_clip_msg-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l389"></a>  vbox_clip_msg-&gt;hdr.req_type = VBOX_REQUEST_HGCM_CALL;
<a name="l390"></a>
<a name="l391"></a>  vbox_clip-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBoxClipConnect);
<a name="l392"></a>  vbox_clip-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l393"></a>  vbox_clip-&gt;hdr.req_type = VBOX_REQUEST_HGCM_CONNECT;
<a name="l394"></a>  vbox_clip-&gt;loc_type = 2;
<a name="l395"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/StrPrint.html#l1043"></span><span class=cB5>StrPrint</a></span><span class=cB0>(&amp;vbox_clip-&gt;loc, </span><span class=cB6>&quot;VBoxSharedClipboard&quot;</span><span class=cB0>);
<a name="l396"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l79"></span><span class=cB5>OutU32</a></span><span class=cB0>(vb_guest.port, vbox_clip);
<a name="l397"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KMisc.html#l137"></span><span class=cB5>Sleep</a></span><span class=cB0>(20);
<a name="l398"></a>  VBHostClipMsgReq;
<a name="l399"></a>  </span><span class=cB1>if</span><span class=cB0> (vbox_clip_msg-&gt;msg.value == 3)
<a name="l400"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l401"></a>    <a href="http://tinkeros.github.io/WbGit/Kernel/Job.html#l462"></span><span class=cB5>AdamLog</a></span><span class=cB0>(</span><span class=cB6>&quot;Enabling VirtualBox shared clipboard!\n&quot;</span><span class=cB0>);
<a name="l402"></a>    </span><span class=cB1>return</span><span class=cB0> <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l22"></span><span class=cB3>TRUE</a></span><span class=cB0>;
<a name="l403"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l404"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/Job.html#l462"></span><span class=cB5>AdamLog</a></span><span class=cB0>(</span><span class=cB6>&quot;VirtualBox shared clipboard NOT enabled!\n&quot;</span><span class=cB0>);
<a name="l405"></a>  </span><span class=cB1>return</span><span class=cB0> <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l23"></span><span class=cB3>FALSE</a></span><span class=cB0>;
<a name="l406"></a>}
<a name="l407"></a>
<a name="l408"></a>
<a name="l409"></a></span><span class=cB1>U0</span><span class=cB0> VBCBReset(</span><span class=cB1>Bool</span><span class=cB0> log=<a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l22"></span><span class=cB3>TRUE</a></span><span class=cB0>)
<a name="l410"></a>{
<a name="l411"></a>  vbox_clip-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBoxClipConnect);
<a name="l412"></a>  vbox_clip-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l413"></a>  vbox_clip-&gt;hdr.req_type = VBOX_REQUEST_HGCM_DISCONNECT;
<a name="l414"></a>  vbox_clip-&gt;loc_type = 2;
<a name="l415"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/StrPrint.html#l1043"></span><span class=cB5>StrPrint</a></span><span class=cB0>(&amp;vbox_clip-&gt;loc, </span><span class=cB6>&quot;VBoxSharedClipboard&quot;</span><span class=cB0>);
<a name="l416"></a>  VBSendMsg(vbox_clip);
<a name="l417"></a>
<a name="l418"></a>  VBHostClipMsgReq;
<a name="l419"></a>
<a name="l420"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l173"></span><span class=cB5>MemSet</a></span><span class=cB0>(vbox_clip,0,</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxClipConnect</span><span class=cB7>)</span><span class=cB0>);
<a name="l421"></a>  vbox_clip-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBoxClipConnect);
<a name="l422"></a>  vbox_clip-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l423"></a>  vbox_clip-&gt;hdr.req_type = VBOX_REQUEST_HGCM_CONNECT;
<a name="l424"></a>  vbox_clip-&gt;loc_type = 2;
<a name="l425"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/StrPrint.html#l1043"></span><span class=cB5>StrPrint</a></span><span class=cB0>(&amp;vbox_clip-&gt;loc, </span><span class=cB6>&quot;VBoxSharedClipboard&quot;</span><span class=cB0>);
<a name="l426"></a>  VBSendMsg(vbox_clip);
<a name="l427"></a>  VBHostClipMsgReq;
<a name="l428"></a>
<a name="l429"></a>  </span><span class=cB1>if</span><span class=cB0> (log) <a href="http://tinkeros.github.io/WbGit/Kernel/Job.html#l462"></span><span class=cB5>AdamLog</a></span><span class=cB0>(</span><span class=cB6>&quot;Reset Virtualbox clipboard!\n&quot;</span><span class=cB0>);
<a name="l430"></a>}
<a name="l431"></a>
<a name="l432"></a>
<a name="l433"></a>
<a name="l434"></a></span><span class=cB1>public</span><span class=cB0> </span><span class=cB1>U0</span><span class=cB0> CopyTextToHost(</span><span class=cB1>U8</span><span class=cB0> *str)
<a name="l435"></a>{
<a name="l436"></a>  VBHostClipFmts;
<a name="l437"></a>  VBHostClipWrite(str);
<a name="l438"></a>  VBHostClipMsgReq;
<a name="l439"></a>}
<a name="l440"></a>
<a name="l441"></a></span><span class=cB1>U8</span><span class=cB0> *GetTextFromHost()
<a name="l442"></a>{
<a name="l443"></a>  </span><span class=cB9>I64</span><span class=cB0> timeout=2;
<a name="l444"></a>
<a name="l445"></a>  vbox_clip_read-&gt;size.value = 0;
<a name="l446"></a>
<a name="l447"></a>  </span><span class=cB1>while</span><span class=cB0> (timeout&gt;0)
<a name="l448"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l449"></a>    </span><span class=cB1>if</span><span class=cB0> (vbox_clip_msg-&gt;msg.value==VBOX_SHARED_CLIPBOARD_HOST_MSG_FMTS)
<a name="l450"></a>    {
<a name="l451"></a>      VBHostClipRead;
<a name="l452"></a>    }
<a name="l453"></a>    VBHostClipMsgReq;
<a name="l454"></a>
<a name="l455"></a>    </span><span class=cB1>if</span><span class=cB0> (timeout==5) VBCBReset(0);
<a name="l456"></a>
<a name="l457"></a>
<a name="l458"></a>    </span><span class=cB1>if</span><span class=cB0> (vbox_clip_read-&gt;size.value)
<a name="l459"></a>    {
<a name="l460"></a>      ToUTF8(utf16_host_read_clipboard, vbox_clip_read-&gt;size.value);
<a name="l461"></a>      vbox_clip_read-&gt;size.value = 0;
<a name="l462"></a>      </span><span class=cB1>return</span><span class=cB0> <a href="http://tinkeros.github.io/WbGit/Kernel/StrPrint.html#l1065"></span><span class=cB5>MStrPrint</a></span><span class=cB0>(</span><span class=cB6>&quot;%s&quot;</span><span class=cB0>,utf8_host_read_clipboard);
<a name="l463"></a>    }
<a name="l464"></a>    <a href="http://tinkeros.github.io/WbGit/Kernel/KMisc.html#l137"></span><span class=cB5>Sleep</a></span><span class=cB0>(10);
<a name="l465"></a>    timeout--;
<a name="l466"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l467"></a>  </span><span class=cB1>return</span><span class=cB0> <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l21"></span><span class=cB3>NULL</a></span><span class=cB0>;
<a name="l468"></a>}
<a name="l469"></a>
<a name="l470"></a></span><span class=cB1>public</span><span class=cB0> </span><span class=cB1>U0</span><span class=cB0> PasteTextFromHost()
<a name="l471"></a>{
<a name="l472"></a>  </span><span class=cB1>U8</span><span class=cB0> *str=GetTextFromHost;
<a name="l473"></a>  </span><span class=cB1>if</span><span class=cB0> (str)
<a name="l474"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l475"></a>    </span><span class=cB6>&quot;%s\n&quot;</span><span class=cB0>,str;
<a name="l476"></a>    <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l415"></span><span class=cB5>Free</a></span><span class=cB0>(str);
<a name="l477"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l478"></a>  </span><span class=cB1>else</span><span class=cB0>
<a name="l479"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l480"></a>    </span><span class=cB6>&quot;Got no text from host clipboard!\n&quot;</span><span class=cB0>;
<a name="l481"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l482"></a>}
<a name="l483"></a>
<a name="l484"></a></span><span class=cB1>U0</span><span class=cB0> CopyCBToHost()
<a name="l485"></a>{
<a name="l486"></a>  </span><span class=cB1>U8</span><span class=cB0> *str=<a href="http://tinkeros.github.io/WbGit/Adam/DolDoc/DocPutS.html#l304"></span><span class=cB5>DocDumpToStr</a></span><span class=cB0>(<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l6"></span><span class=cB6>sys_clip_doc</a></span><span class=cB0>);
<a name="l487"></a>  </span><span class=cB1>if</span><span class=cB0> (str) CopyTextToHost(str);
<a name="l488"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l415"></span><span class=cB5>Free</a></span><span class=cB0>(str);
<a name="l489"></a>}
<a name="l490"></a>
<a name="l491"></a></span><span class=cB1>public</span><span class=cB0> </span><span class=cB1>U0</span><span class=cB0> CopyCBFromHost()
<a name="l492"></a>{
<a name="l493"></a>  </span><span class=cB1>U8</span><span class=cB0> *host_cb=GetTextFromHost;
<a name="l494"></a>  </span><span class=cB1>if</span><span class=cB0> (host_cb)
<a name="l495"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l496"></a>    <a href="http://tinkeros.github.io/WbGit/Adam/DolDoc/DocClipBoard.html#l19"></span><span class=cB5>ClipDel</a></span><span class=cB0>;
<a name="l497"></a>    <a href="http://tinkeros.github.io/WbGit/Adam/DolDoc/DocPutS.html#l168"></span><span class=cB5>DocPrint</a></span><span class=cB0>(<a href="http://tinkeros.github.io/WbGit/Kernel/KGlbls.html#l6"></span><span class=cB6>sys_clip_doc</a></span><span class=cB0>,host_cb);
<a name="l498"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l499"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l415"></span><span class=cB5>Free</a></span><span class=cB0>(host_cb);
<a name="l500"></a>}
<a name="l501"></a>
<a name="l502"></a></span><span class=cB1>U0</span><span class=cB0> ClipHijackInit()
<a name="l503"></a>{
<a name="l504"></a>  <a href="http://tinkeros.github.io/WbGit/Adam/Opt/Utils/Adam.html#l8"></span><span class=cB5>HijackFunc</a></span><span class=cB0>(&amp;<a href="http://tinkeros.github.io/WbGit/Adam/DolDoc/DocClipBoard.html#l8"></span><span class=cB5>ClipCutCB</a></span><span class=cB0>,&amp;CopyCBToHost);
<a name="l505"></a>  <a href="http://tinkeros.github.io/WbGit/Adam/Opt/Utils/Adam.html#l8"></span><span class=cB5>HijackFunc</a></span><span class=cB0>(&amp;<a href="http://tinkeros.github.io/WbGit/Adam/DolDoc/DocClipBoard.html#l3"></span><span class=cB5>ClipCopyCB</a></span><span class=cB0>,&amp;CopyCBToHost);
<a name="l506"></a>  <a href="http://tinkeros.github.io/WbGit/Adam/Opt/Utils/Adam.html#l8"></span><span class=cB5>HijackFunc</a></span><span class=cB0>(&amp;<a href="http://tinkeros.github.io/WbGit/Adam/DolDoc/DocClipBoard.html#l13"></span><span class=cB5>ClipPasteCB</a></span><span class=cB0>,&amp;CopyCBFromHost);
<a name="l507"></a>}
<a name="l508"></a>
<a name="l509"></a></span><span class=cB1>U0</span><span class=cB0> VBLog(</span><span class=cB1>U8</span><span class=cB0> *str)
<a name="l510"></a>{
<a name="l511"></a>  </span><span class=cB1>while</span><span class=cB0> (*str)
<a name="l512"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l513"></a>    <a href="http://tinkeros.github.io/WbGit/Kernel/KMisc.html#l1"></span><span class=cB5>PortNop</a></span><span class=cB0>;
<a name="l514"></a>    <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l80"></span><span class=cB5>OutU8</a></span><span class=cB0>(0x504,*str++);
<a name="l515"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l516"></a>}
<a name="l517"></a>
<a name="l518"></a></span><span class=cB1>U0</span><span class=cB0> VBLogInit()
<a name="l519"></a>{
<a name="l520"></a>  VBoxCaps *caps =
<a name="l521"></a>      <a href="http://tinkeros.github.io/WbGit/Kernel/Mem/MAllocFree.html#l466"></span><span class=cB5>CAllocAligned</a></span><span class=cB0>(</span><span class=cB1>sizeof</span><span class=cB7>(</span><span class=cB0>VBoxCaps</span><span class=cB7>)</span><span class=cB0>, 16, <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l292"></span><span class=cB5>Fs</a></span><span class=cB0>-&gt;code_heap);
<a name="l522"></a>  caps-&gt;hdr.size = </span><span class=cB1>sizeof</span><span class=cB0>(VBGuestInfo);
<a name="l523"></a>  caps-&gt;hdr.ver = VBOX_REQUEST_HEADER_VERSION;
<a name="l524"></a>  caps-&gt;hdr.req_type = VBOX_REQUEST_SET_GUEST_CAPS;
<a name="l525"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelB.html#l79"></span><span class=cB5>OutU32</a></span><span class=cB0>(vb_guest.port, caps);
<a name="l526"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KMisc.html#l137"></span><span class=cB5>Sleep</a></span><span class=cB0>(20);
<a name="l527"></a>}
<a name="l528"></a>
<a name="l529"></a></span><span class=cB1>U0</span><span class=cB0> VBInitAll()
<a name="l530"></a>{
<a name="l531"></a>  <a href="http://tinkeros.github.io/WbGit/Kernel/KernelA.html#l3795"></span><span class=cB9>CTask</a></span><span class=cB0> *old_ms_task=<a href="http://tinkeros.github.io/WbGit/Adam/ATask.html#l151"></span><span class=cB5>FindTaskByTitle</a></span><span class=cB0>(</span><span class=cB6>&quot;VBMsTask&quot;</span><span class=cB0>);
<a name="l532"></a>
<a name="l533"></a>  </span><span class=cB1>if</span><span class=cB0> (old_ms_task) <a href="http://tinkeros.github.io/WbGit/Kernel/KTask.html#l52"></span><span class=cB5>Kill</a></span><span class=cB0>(old_ms_task);
<a name="l534"></a>
<a name="l535"></a>  </span><span class=cB1>Bool</span><span class=cB0> have_vb=VBGuestInit;
<a name="l536"></a>
<a name="l537"></a>  </span><span class=cB1>if</span><span class=cB0> (have_vb)
<a name="l538"></a>  </span><span class=cB7>{</span><span class=cB0>
<a name="l539"></a>    <a href="http://tinkeros.github.io/WbGit/Kernel/Job.html#l462"></span><span class=cB5>AdamLog</a></span><span class=cB0>(</span><span class=cB6>&quot;Found VirtualBox!\n&quot;</span><span class=cB0>);
<a name="l540"></a>    VBLogInit;
<a name="l541"></a>    VBMouseInit;
<a name="l542"></a>    </span><span class=cB2>// Uncomment if you want experimental clipboard integration</span><span class=cB0>
<a name="l543"></a>    </span><span class=cB2>// must be enabled as bidirectional and is WIP might stop</span><span class=cB0>
<a name="l544"></a>    </span><span class=cB2>// working randomly though I've had luck moving entire</span><span class=cB0>
<a name="l545"></a>    </span><span class=cB2>// files of text in and out with it.</span><span class=cB0>
<a name="l546"></a>    </span><span class=cB2>/*</span><span class=cB0>
<a name="l547"></a></span><span class=cB2>    if (VBClipInit)</span><span class=cB0>
<a name="l548"></a></span><span class=cB2>      ClipHijackInit;</span><span class=cB0>
<a name="l549"></a></span><span class=cB2>    */</span><span class=cB0>
<a name="l550"></a>    VBLog(</span><span class=cB6>&quot;Initialized TinkerOS guest additions!\n&quot;</span><span class=cB0>);
<a name="l551"></a>  </span><span class=cB7>}</span><span class=cB0>
<a name="l552"></a>}
<a name="l553"></a>
<a name="l554"></a></span><span class=cB1>U0</span><span class=cB0> DumpCBMsg()
<a name="l555"></a>{
<a name="l556"></a>  <a href="http://tinkeros.github.io/WbGit/Adam/ADbg.html#l205"></span><span class=cB5>ClassRep</a></span><span class=cB0>(vbox_clip_msg);
<a name="l557"></a>}
<a name="l558"></a>
<a name="l559"></a>VBInitAll;
<a name="l560"></a>
<a name="l561"></a>
</span></div></pre></body>
</html>
